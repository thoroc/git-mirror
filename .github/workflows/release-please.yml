name: release-please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create or update Release PR (release-please)
        id: prepare_release
        uses: googleapis/release-please-action@v4
        with:
          release-type: rust
          package-name: git-mirror
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}

      - name: Auto-approve and merge Release PR
        if: ${{ steps.prepare_release.outputs.prs_created == 'true' }}
        uses: actions/github-script@v6
        with:
          script: |
            const core = require('@actions/core');
            const prs = JSON.parse(process.env.PRS || '[]');
            const pr = Array.isArray(prs) ? prs[0] : prs;
            if (!pr) {
              core.info('No release PR found to merge');
              return;
            }
            const prNumber = pr.number;
            core.info(`Approving PR #${prNumber}`);
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: 'APPROVE'
            });
            core.info(`Merging PR #${prNumber}`);
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'squash'
            });
        env:
          PRS: ${{ steps.prepare_release.outputs.prs }}

      - name: Create or update GitHub Release (release-please)
        id: publish_release
        uses: googleapis/release-please-action@v4
        with:
          release-type: rust
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          skip-github-pull-request: true

      - name: Build Rust release binary
        if: ${{ steps.publish_release.outputs.release_created == 'true' }}
        run: |
          # Install minimal dependencies for building OpenSSL-based crates when needed
          sudo apt-get update && sudo apt-get install -y pkg-config libssl-dev || true
          cargo build --release

      - name: Install GitHub CLI
        if: ${{ steps.publish_release.outputs.release_created == 'true' }}
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y curl gnupg || true
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update && sudo apt-get install -y gh || true
          fi

      - name: Upload release artifact
        if: ${{ steps.publish_release.outputs.release_created == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}
        run: |
          gh auth setup-git || true
          gh --version
          TAG=${{ steps.publish_release.outputs.tag_name }}
          echo "Uploading artifact for $TAG"
          gh release upload "$TAG" ./target/release/git-mirror --clobber
